<!-- profile.html -->
<section class="data-card profile-page">
  <div class="card profile-header">
    <div class="avatar-wrap" id="avatarWrap" title="Изменить аватар">
      <img id="avatarPreview" alt="avatar" />
      <i id="avatarFallback" data-lucide="user"></i>
      <input type="file" id="avatarInput" accept="image/*" aria-label="Выбрать аватар" />
    </div>
    <h2 class="profile-title">Профиль пользователя</h2>
    <button class="btn" id="btnSignOut"><i data-lucide="log-out"></i><span>Выйти</span></button>
  </div>

  <div class="card auth-card" id="authCard" hidden>
    <h3 class="card-title auth-card__title">Вход или регистрация</h3>
    <div class="auth-grid">
      <div class="auth-col">
        <h4>Вход</h4>
        <div class="form-field">
          <label for="signinEmail">Email</label>
          <input type="email" id="signinEmail" placeholder="you@company.com" />
        </div>
        <div class="form-field">
          <label for="signinPassword">Пароль</label>
          <input type="password" id="signinPassword" placeholder="••••••••" />
        </div>
        <button class="btn primary" id="btnSignIn"><i data-lucide="log-in"></i><span>Войти</span></button>
      </div>
      <div class="auth-col">
        <h4>Регистрация</h4>
        <div class="form-field">
          <label for="signupEmail">Email</label>
          <input type="email" id="signupEmail" placeholder="you@company.com" />
        </div>
        <div class="form-field">
          <label for="signupPassword">Пароль</label>
          <input type="password" id="signupPassword" placeholder="Минимум 6 символов" />
        </div>
        <button class="btn success" id="btnSignUp"><i data-lucide="user-plus"></i><span>Зарегистрироваться</span></button>
        <p class="muted">После регистрации может потребоваться подтверждение email.</p>
      </div>
    </div>
    <div id="authMsg" class="msg"></div>
  </div>

  <div class="card profile-form-card" id="profileCard" hidden>
    <div class="card-title-row">
      <h3 class="card-title">Основные данные</h3>
      <button class="btn" id="btnSaveProfile"><i data-lucide="save"></i><span>Сохранить профиль</span></button>
    </div>
    <div class="form-grid">
      <div class="form-row">
        <div class="form-field">
          <label for="firstName">Имя</label>
          <input type="text" id="firstName" placeholder="Иван" />
        </div>
        <div class="form-field">
          <label for="lastName">Фамилия</label>
          <input type="text" id="lastName" placeholder="Иванов" />
        </div>
        <div class="form-field">
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="you@company.com" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label for="departmentSelect">Подразделение</label>
          <select id="departmentSelect">
            <option value="">Выберите подразделение</option>
          </select>
        </div>
        <div class="form-field">
          <label for="jobTitle">Должность</label>
          <input type="text" id="jobTitle" placeholder="Руководитель отдела" />
        </div>
      </div>
    </div>
    <div id="profileMsg" class="msg"></div>
  </div>

  <div class="card profile-security-card" id="securityCard" hidden>
    <div class="card-title-row">
      <h3 class="card-title">Безопасность</h3>
      <button class="btn" id="btnChangePassword"><i data-lucide="shield"></i><span>Сменить пароль</span></button>
    </div>
    <div class="form-grid small">
      <div class="form-field">
        <label for="newPassword">Новый пароль</label>
        <input type="password" id="newPassword" placeholder="••••••••" />
      </div>
      <div class="form-field">
        <label for="confirmPassword">Подтверждение пароля</label>
        <input type="password" id="confirmPassword" placeholder="••••••••" />
      </div>
    </div>
    <div id="securityMsg" class="msg"></div>
  </div>
</section>

<style>
  .profile-page { display: flex; flex-direction: column; gap: 16px; }
  .profile-page .card {
    border: 2px solid #4A89F3;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(74, 137, 243, 0.15);
  }
  .profile-header {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    flex-direction: row !important;
    flex-wrap: nowrap !important;
    gap: 0;
    padding: 12px 16px;
    min-height: 48px;
    width: 100%;
  }
  .profile-header .avatar-wrap {
    margin-right: 8px;
  }
  .profile-header .profile-title {
    margin-right: auto;
  }
  .profile-title {
    margin: 0;
    font-size: 22px;
    font-weight: 800;
    color: var(--blue);
    white-space: nowrap;
  }
  .avatar-wrap {
    position: relative;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid var(--border);
    background: var(--surface);
    display: grid;
    place-items: center;
    cursor: pointer;
    flex-shrink: 0;
  }
  .avatar-wrap img { width: 100%; height: 100%; object-fit: cover; display:none; }
  .avatar-wrap i { width: 20px; height: 20px; color: var(--muted); }
  .avatar-wrap:hover{ box-shadow: var(--shadow); transform: translateY(-1px); }
  .avatar-wrap input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .auth-card .auth-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-top: 8px; }
  .auth-card .auth-col { background: var(--surface); border: 1px solid var(--border); border-radius: var(--r-10); padding: 12px; }
  .auth-card__title { text-align: center; margin-bottom: 20px; font-size: 20px; font-weight: 700; }
  .profile-form-card .form-grid { display: flex; flex-direction: column; gap: 16px; }
  .profile-form-card .form-row { display: grid; gap: 12px; }
  .profile-form-card .form-row:first-child { grid-template-columns: repeat(3, 1fr); }
  .profile-form-card .form-row:last-child { grid-template-columns: repeat(2, 3fr); gap: 20px; }
  .profile-security-card .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
  .profile-security-card .form-grid.small { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
  .form-field { display: flex; flex-direction: column; gap: 6px; }
  .form-field label { font-weight: 700; color: var(--muted); font-size: 13px; }
  .form-field input, .form-field select { border: 1px solid var(--border); border-radius: var(--r-8); padding: 8px 10px; background: var(--surface); color: var(--text); }
  .form-field input:focus, .form-field select:focus { outline: none; box-shadow: 0 0 0 2px rgba(74,137,243,0.18); border-color: var(--blue); }
  .card-title-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 6px; }
  .card-title { margin: 0; font-size: 18px; font-weight: 800; color: var(--blue); }
  .btn { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: var(--r-8); border: 1px solid var(--border); background: var(--surface); color: var(--text); cursor: pointer; font-weight: 700; transition: transform .1s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease; }
  .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); border-color: var(--blue); }
  .btn.primary { background: var(--blue); border-color: var(--blue); color: #fff; }
  .btn.primary:hover { filter: brightness(1.05); }
  .btn.success { background: var(--success); border-color: var(--success); color: #fff; }
  .btn.success:hover { filter: brightness(1.05); }
  .msg { margin-top: 8px; font-size: 13px; color: var(--muted); }
  .msg.error { color: var(--danger); }
  .msg.ok { color: var(--success); }
  @media (max-width: 560px) { .avatar-wrap { width: 36px; height: 36px; } .avatar-wrap i { width: 18px; height: 18px; } .profile-title { font-size: 18px; } }
  :root[data-theme="dark"] .auth-card .auth-col{ background: var(--surface-1); }
</style>

<!-- ENV: вставьте ваши значения -->
<script>
  window.ENV = {
    SUPABASE_URL: 'https://eqpdepmgriuivevvrulc.supabase.co',
    SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxcGRlcG1ncml1aXZldnZydWxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNjIwOTUsImV4cCI6MjA3MTkzODA5NX0.RrU_XWmoYCitZoeq27aH9iKJrb_wczOei8P4h0e2GR8'
  };
</script>

<!-- Supabase SDK -->
<script src="https://unpkg.com/@supabase/supabase-js@2.45.2/dist/umd/supabase.js"></script>

<!-- Логика страницы -->
<script>
(async function() {
  // 1) Гарантируем доступность Supabase SDK (подгрузим, если не подключен)
  async function ensureSupabaseSDK() {
    if (window.supabase?.createClient) return;
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = 'https://unpkg.com/@supabase/supabase-js@2.45.2/dist/umd/supabase.js';
      s.onload = resolve;
      s.onerror = () => reject(new Error('Не удалось загрузить Supabase SDK'));
      document.head.appendChild(s);
    });
  }
  await ensureSupabaseSDK();

  // 2) Клиент Supabase (устойчивые сессии)
  const { SUPABASE_URL, SUPABASE_ANON_KEY } = window.ENV || {};
  const authMsg = document.getElementById('authMsg');
  if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes('YOUR-PROJECT')) {
    if (authMsg) {
      authMsg.textContent = 'Не заданы ENV (SUPABASE_URL/SUPABASE_ANON_KEY). Задайте window.ENV перед скриптом.';
      authMsg.classList.add('error');
    }
    return;
  }
  const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true
    }
  });

  // 3) Утилиты и ссылки
  const qs = (sel, root = document) => root.querySelector(sel);
  const escapeHtml = (s) => String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
  const fileToDataURL = (file) => new Promise((res, rej) => {
    const r = new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);
  });

  const profileCard = qs('#profileCard');
  const securityCard = qs('#securityCard');
  const profileMsg = qs('#profileMsg');
  const securityMsg = qs('#securityMsg');

  const avatarInput = qs('#avatarInput');
  const avatarPreview = qs('#avatarPreview');
  const avatarFallback = qs('#avatarFallback');

  const btnSignIn = qs('#btnSignIn');
  const btnSignUp = qs('#btnSignUp');
  const btnSignOut = qs('#btnSignOut');
  const btnSaveProfile = qs('#btnSaveProfile');
  const btnChangePassword = qs('#btnChangePassword');

  const signinEmail = qs('#signinEmail');
  const signinPassword = qs('#signinPassword');
  const signupEmail = qs('#signupEmail');
  const signupPassword = qs('#signupPassword');

  const firstName = qs('#firstName');
  const lastName = qs('#lastName');
  const email = qs('#email');
  const jobTitle = qs('#jobTitle');
  const departmentSelect = qs('#departmentSelect');

  const newPassword = qs('#newPassword');
  const confirmPassword = qs('#confirmPassword');

  function setMsg(el, text, ok=false) {
    if (!el) return;
    el.textContent = text || '';
    el.classList.remove('error','ok');
    if (text) el.classList.add(ok ? 'ok' : 'error');
  }

  // 4) Ждём смены сессии → обновляем UI
  supa.auth.onAuthStateChange(() => refreshAuthUI());

  // 5) UI обновление по сессии
  async function refreshAuthUI() {
    const { data: { user } } = await supa.auth.getUser();
    if (user) {
      qs('#authCard').hidden = true;
      profileCard.hidden = false;
      securityCard.hidden = false;
      btnSignOut.hidden = false;
      
      await loadDepartments();
      await loadOrCreateProfile(user);
      
      const pending = localStorage.getItem('pending_avatar_b64');
      if (pending) {
        await saveAvatarURLToProfile(pending);
        localStorage.removeItem('pending_avatar_b64');
      }
    } else {
      qs('#authCard').hidden = false;
      profileCard.hidden = true;
      securityCard.hidden = true;
      btnSignOut.hidden = true;
    }
    try { window.lucide?.createIcons?.(); } catch(e){}
  }

  // 6) Справочник подразделений
  async function loadDepartments() {
    try {
      const { data, error } = await supa
        .from('BOLT_orgchat')
        .select('"Department Name" as department_name')
        .order('department_name', { ascending: true });
      if (error) throw error;
      const opts = (data || [])
        .map(r => r.department_name)
        .filter(Boolean)
        .map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`)
        .join('');
      departmentSelect.innerHTML = '<option value="">Выберите подразделение</option>' + opts;
    } catch (e) {
      console.error('loadDepartments error:', e);
      departmentSelect.innerHTML = '<option value="">Не удалось загрузить список</option>';
    }
  }

  // 7) Профиль: загрузка/создание
  async function loadOrCreateProfile(user) {
    setMsg(profileMsg, 'Загрузка профиля...', true);
    try {
      let { data: profile, error } = await supa
        .from('profiles')
        .select('*')
        .eq('user_id', user.id)
        .single();
      if (error && error.code !== 'PGRST116') throw error;

      if (!profile) {
        const initial = { user_id: user.id, email: user.email ?? '', first_name: '', last_name: '', job_title: '', department_name: null, avatar_url: null };
        const ins = await supa.from('profiles').insert(initial).select('*').single();
        if (ins.error) throw ins.error;
        profile = ins.data;
      }
      
      firstName.value = profile.first_name || '';
      lastName.value = profile.last_name || '';
      email.value = profile.email || (user.email ?? '');
      jobTitle.value = profile.job_title || '';
      
      if (profile.department_name) {
        const exists = Array.from(departmentSelect.options).some(o => o.value === profile.department_name);
        if (!exists) {
          const opt = document.createElement('option');
          opt.value = profile.department_name; opt.textContent = profile.department_name;
          departmentSelect.appendChild(opt);
        }
        departmentSelect.value = profile.department_name;
      } else {
        departmentSelect.value = '';
      }
      
      if (profile.avatar_url) {
        avatarPreview.src = profile.avatar_url;
        avatarPreview.style.display = 'block';
        avatarFallback.style.display = 'none';
      } else {
        avatarPreview.src = '';
        avatarPreview.style.display = 'none';
        avatarFallback.style.display = 'block';
      }
      
      setMsg(profileMsg, 'Профиль загружен.', true);
      setTimeout(() => setMsg(profileMsg, ''), 1200);
    } catch (e) {
      console.error('loadOrCreateProfile error:', e);
      setMsg(profileMsg, `Ошибка загрузки профиля: ${e.message || e}`);
    }
  }

  // 8) Сохранить профиль
  btnSaveProfile?.addEventListener('click', async () => {
    setMsg(profileMsg, '');
    try {
      const { data: { user } } = await supa.auth.getUser();
      if (!user) throw new Error('Сначала войдите в систему.');
      
      const payload = {
        first_name: firstName.value.trim(),
        last_name: lastName.value.trim(),
        email: email.value.trim(),
        job_title: jobTitle.value.trim(),
        department_name: departmentSelect.value || null,
        updated_at: new Date().toISOString(),
      };
      
      const { error } = await supa.from('profiles').update(payload).eq('user_id', user.id);
      if (error) throw error;
      
      const curEmail = user.email ?? '';
      if (payload.email && payload.email !== curEmail) {
        const { error: auErr } = await supa.auth.updateUser({ email: payload.email });
        if (auErr) {
          console.warn('auth update email:', auErr);
          setMsg(profileMsg, 'Профиль сохранён. Смена email: ошибка или требуется подтверждение.', true);
        } else {
          setMsg(profileMsg, 'Профиль сохранён. Проверьте почту для подтверждения смены email.', true);
        }
      } else {
        setMsg(profileMsg, 'Профиль сохранён.', true);
      }
      setTimeout(() => setMsg(profileMsg, ''), 2000);
    } catch (e) {
      console.error('save profile error:', e);
      setMsg(profileMsg, `Ошибка сохранения профиля: ${e.message || e}`);
    }
  });

  // 9) Смена пароля
  btnChangePassword?.addEventListener('click', async () => {
    setMsg(securityMsg, '');
    const pass1 = (qs('#newPassword').value || '').trim();
    const pass2 = (qs('#confirmPassword').value || '').trim();
    if (!pass1 || pass1.length < 6) { setMsg(securityMsg, 'Пароль должен быть не короче 6 символов.'); return; }
    if (pass1 !== pass2) { setMsg(securityMsg, 'Пароли не совпадают.'); return; }
    
    try {
      const { data: { user } } = await supa.auth.getUser();
      if (!user) throw new Error('Сначала войдите в систему.');
      
      const { error } = await supa.auth.updateUser({ password: pass1 });
      if (error) throw error;
      
      setMsg(securityMsg, 'Пароль обновлён.', true);
      qs('#newPassword').value=''; qs('#confirmPassword').value='';
      setTimeout(() => setMsg(securityMsg, ''), 2000);
    } catch (e) {
      console.error('change password error:', e);
      setMsg(securityMsg, `Ошибка изменения пароля: ${e.message || e}`);
    }
  });

  // 10) Вход
  btnSignIn?.addEventListener('click', async () => {
    setMsg(authMsg, '');
    try {
      const email = (signinEmail.value || '').trim();
      const password = (signinPassword.value || '').trim();
      if (!email || !password) throw new Error('Введите email и пароль.');
      
      const { error } = await supa.auth.signInWithPassword({ email, password });
      if (error) throw error;
      
      setMsg(authMsg, 'Успешный вход.', true);
      await refreshAuthUI();
    } catch (e) {
      console.error('signIn error:', e);
      setMsg(authMsg, `Ошибка входа: ${e.message || e}`);
    }
  });

  // 11) Регистрация
  btnSignUp?.addEventListener('click', async () => {
    setMsg(authMsg, '');
    try {
      const email = (signupEmail.value || '').trim();
      const password = (signupPassword.value || '').trim();
      if (!email || !password || password.length < 6) throw new Error('Введите корректные email и пароль (≥6).');

      const { data, error } = await supa.auth.signUp({ email, password });
      
      if (error) {
        const msg = (error.message || '').toLowerCase();
        if (msg.includes('already') || msg.includes('exist') || error.status === 422) {
          const si = await supa.auth.signInWithPassword({ email, password });
          if (si.error) throw si.error;
          setMsg(authMsg, 'Учетная запись уже существует — выполнен вход.', true);
          await refreshAuthUI();
          return;
        }
        throw error;
      }
      
      if (data?.user?.id) {
        setMsg(authMsg, 'Регистрация выполнена. Проверьте почту (если требуется подтверждение).', true);
        try { await loadOrCreateProfile(data.user); } catch(_) {}
        await refreshAuthUI();
      } else {
        setMsg(authMsg, 'Регистрация выполнена. Проверьте почту для подтверждения.', true);
      }
    } catch (e) {
      console.error('signUp error:', e);
      setMsg(authMsg, `Ошибка регистрации: ${e.message || e}`);
    }
  });

  // 12) Выход
  btnSignOut?.addEventListener('click', async () => {
    await supa.auth.signOut();
    setMsg(authMsg, 'Вы вышли из системы.', true);
    await refreshAuthUI();
  });

  // 13) Аватар
  async function saveAvatarURLToProfile(url) {
    const { data: { user } } = await supa.auth.getUser();
    if (!user) return false;
    const { error } = await supa.from('profiles').update({ avatar_url: url, updated_at: new Date().toISOString() }).eq('user_id', user.id);
    if (error) throw error;
    
    // Обновляем кэш
    const cached = readCache(user.id) || {};
    cached.avatar_url = url;
    writeCache(user.id, cached);
    
    return true;
  }

  avatarInput?.addEventListener('change', async (e) => {
    const file = e.target.files?.[0]; e.target.value = '';
    if (!file) return;
    
    const MAX_MB = 5;
    const allowed = /^image\/(png|jpe?g|webp|gif)$/i;
    if (!allowed.test(file.type)) { setMsg(profileMsg, 'Поддерживаются PNG/JPG/WebP/GIF.'); return; }
    if (file.size > MAX_MB * 1024 * 1024) { setMsg(profileMsg, `Размер файла ≤ ${MAX_MB} МБ.`); return; }
    
    const previewUrl = await fileToDataURL(file);
    avatarPreview.src = previewUrl;
    avatarPreview.style.display = 'block';
    avatarFallback.style.display = 'none';

    try {
      const { data: { user } } = await supa.auth.getUser();
      if (!user) {
        localStorage.setItem('pending_avatar_b64', previewUrl);
        setMsg(profileMsg, 'Аватар будет сохранён после входа.', true);
        return;
      }
      
      let finalUrl = '';
      try {
        const ext = (file.name.split('.').pop() || 'png').toLowerCase();
        const filePath = `${user.id}/avatar_${Date.now()}.${ext}`;
        const up = await supa.storage.from('avatars').upload(filePath, file, { upsert: true, cacheControl: '3600', contentType: file.type });
        if (up.error) throw up.error;
        
        const { data: pub } = supa.storage.from('avatars').getPublicUrl(filePath);
        finalUrl = pub?.publicUrl;
        if (!finalUrl) {
          const signed = await supa.storage.from('avatars').createSignedUrl(filePath, 60*60*24*365);
          if (signed.error) throw signed.error;
          finalUrl = signed.data.signedUrl;
        }
      } catch (storageErr) {
        console.warn('Storage недоступен, сохраняем как base64:', storageErr?.message || storageErr);
        finalUrl = previewUrl;
      }
      
      await saveAvatarURLToProfile(finalUrl);
      setMsg(profileMsg, 'Аватар обновлён.', true);
      setTimeout(() => setMsg(profileMsg, ''), 2000);
      document.dispatchEvent(new CustomEvent('profile:avatar-updated', { detail: { url: finalUrl } }));
    } catch (e2) {
      console.error('avatar error:', e2);
      setMsg(profileMsg, `Ошибка обновления аватара: ${e2.message || e2}`);
    }
  });

  // 14) Старт
  refreshAuthUI();
})();
</script>