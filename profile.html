<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Профиль пользователя</title>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

<div class="profile-app">
  <!-- Шапка профиля (для авторизованных) -->
  <header class="profile-header" id="profileHeader" style="display: none;">
    <div class="header-container">
      <div class="user-section">
        <div class="avatar-wrapper">
          <img id="headerAvatar" class="avatar-img" alt="Avatar">
          <div id="headerAvatarPlaceholder" class="avatar-placeholder">
            <i data-lucide="user"></i>
          </div>
          <label for="avatarInput" class="avatar-upload-btn">
            <i data-lucide="camera"></i>
          </label>
          <input type="file" id="avatarInput" accept="image/*" style="display: none;">
        </div>
        <div class="user-info">
          <h1 id="headerName">Загрузка...</h1>
          <p id="headerEmail">...</p>
        </div>
      </div>
      <button class="btn btn-ghost" id="btnSignOut">
        <i data-lucide="log-out"></i>
        <span>Выйти</span>
      </button>
    </div>
  </header>

  <!-- Блок аутентификации -->
  <div class="auth-container" id="authContainer">
    <div class="auth-card">
      <div class="auth-logo">
        <i data-lucide="shield"></i>
      </div>
      <h2 class="auth-title">Добро пожаловать</h2>
      <p class="auth-subtitle">Войдите или создайте новый аккаунт</p>
      
      <div class="auth-tabs">
        <button class="tab-btn active" data-tab="signin">Вход</button>
        <button class="tab-btn" data-tab="signup">Регистрация</button>
      </div>

      <!-- Форма входа -->
      <form id="signinForm" class="auth-form">
        <div class="form-field">
          <label for="signinEmail">Email</label>
          <div class="input-wrapper">
            <i data-lucide="mail"></i>
            <input type="email" id="signinEmail" placeholder="you@company.com" required>
          </div>
        </div>
        <div class="form-field">
          <label for="signinPassword">Пароль</label>
          <div class="input-wrapper">
            <i data-lucide="lock"></i>
            <input type="password" id="signinPassword" placeholder="••••••••" required>
          </div>
        </div>
        <button type="submit" class="btn btn-primary btn-block">
          <i data-lucide="log-in"></i>
          <span>Войти</span>
        </button>
      </form>

      <!-- Форма регистрации -->
      <form id="signupForm" class="auth-form" style="display: none;">
        <div class="form-field">
          <label for="signupEmail">Email</label>
          <div class="input-wrapper">
            <i data-lucide="mail"></i>
            <input type="email" id="signupEmail" placeholder="you@company.com" required>
          </div>
        </div>
        <div class="form-field">
          <label for="signupPassword">Пароль</label>
          <div class="input-wrapper">
            <i data-lucide="lock"></i>
            <input type="password" id="signupPassword" placeholder="Минимум 6 символов" required minlength="6">
          </div>
        </div>
        <button type="submit" class="btn btn-success btn-block">
          <i data-lucide="user-plus"></i>
          <span>Создать аккаунт</span>
        </button>
      </form>

      <div id="authMsg" class="message"></div>
    </div>
  </div>

  <!-- Блок данных профиля -->
  <div class="profile-container" id="profileContainer" style="display: none;">
    <!-- Основные данные -->
    <div class="profile-card">
      <div class="card-header">
        <h3>
          <i data-lucide="user"></i>
          <span>Основные данные</span>
        </h3>
      </div>
      <form id="profileForm" class="profile-form">
        <div class="form-row">
          <div class="form-field">
            <label for="lastName">Фамилия</label>
            <input type="text" id="lastName" placeholder="Иванов">
          </div>
          <div class="form-field">
            <label for="firstName">Имя</label>
            <input type="text" id="firstName" placeholder="Иван">
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="jobTitle">Должность</label>
            <input type="text" id="jobTitle" placeholder="Менеджер">
          </div>
          <div class="form-field">
            <label for="department">Подразделение</label>
            <select id="department">
              <option value="">Загрузка...</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="phone">Телефон</label>
            <input type="tel" id="phone" placeholder="+7 (999) 123-45-67">
          </div>
          <div class="form-field">
            <label for="officeLocation">Офис</label>
            <input type="text" id="officeLocation" placeholder="Москва">
          </div>
        </div>
        <button type="submit" class="btn btn-primary">
          <i data-lucide="save"></i>
          <span>Сохранить</span>
        </button>
        <div id="profileMsg" class="message"></div>
      </form>
    </div>

    <!-- Блок безопасности -->
    <div class="profile-card">
      <div class="card-header">
        <h3>
          <i data-lucide="shield"></i>
          <span>Безопасность</span>
        </h3>
      </div>
      <form id="passwordForm" class="profile-form">
        <div class="form-row">
          <div class="form-field">
            <label for="newPassword">Новый пароль</label>
            <input type="password" id="newPassword" placeholder="Минимум 6 символов" minlength="6">
          </div>
          <div class="form-field">
            <label for="confirmPassword">Подтверждение пароля</label>
            <input type="password" id="confirmPassword" placeholder="Повторите пароль">
          </div>
        </div>
        <button type="submit" class="btn btn-warning">
          <i data-lucide="key"></i>
          <span>Сменить пароль</span>
        </button>
        <div id="passwordMsg" class="message"></div>
      </form>
    </div>
  </div>
</div>

<style>
  :root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --dark: #1f2937;
    --gray: #6b7280;
    --light: #f3f4f6;
    --white: #ffffff;
    --radius: 12px;
    --shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    --shadow-sm: 0 2px 10px rgba(0, 0, 0, 0.05);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: var(--dark);
  }

  .profile-app {
    min-height: 100vh;
    padding: 20px;
  }

  /* Шапка профиля */
  .profile-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: var(--radius);
    margin-bottom: 30px;
    box-shadow: var(--shadow);
  }

  .header-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
  }

  .user-section {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .avatar-wrapper {
    position: relative;
    width: 80px;
    height: 80px;
  }

  .avatar-img,
  .avatar-placeholder {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  .avatar-img {
    display: none;
  }

  .avatar-placeholder {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
  }

  .avatar-placeholder i {
    width: 35px;
    height: 35px;
  }

  .avatar-upload-btn {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 28px;
    height: 28px;
    background: var(--primary);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    transition: transform 0.2s;
    box-shadow: var(--shadow-sm);
  }

  .avatar-upload-btn:hover {
    transform: scale(1.1);
  }

  .avatar-upload-btn i {
    width: 16px;
    height: 16px;
  }

  .user-info h1 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 4px;
  }

  .user-info p {
    color: var(--gray);
    font-size: 14px;
  }

  /* Блок аутентификации */
  .auth-container {
    max-width: 440px;
    margin: 100px auto;
  }

  .auth-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: var(--radius);
    padding: 40px;
    box-shadow: var(--shadow);
  }

  .auth-logo {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    color: white;
  }

  .auth-logo i {
    width: 30px;
    height: 30px;
  }

  .auth-title {
    text-align: center;
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 8px;
  }

  .auth-subtitle {
    text-align: center;
    color: var(--gray);
    margin-bottom: 30px;
  }

  .auth-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    background: var(--light);
    padding: 4px;
    border-radius: 8px;
  }

  .tab-btn {
    flex: 1;
    padding: 10px;
    border: none;
    background: transparent;
    border-radius: 6px;
    font-weight: 600;
    color: var(--gray);
    cursor: pointer;
    transition: all 0.3s;
  }

  .tab-btn.active {
    background: white;
    color: var(--primary);
    box-shadow: var(--shadow-sm);
  }

  /* Формы */
  .auth-form,
  .profile-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
  }

  .form-field {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .form-field label {
    font-size: 14px;
    font-weight: 600;
    color: var(--dark);
  }

  .form-field input,
  .form-field select {
    padding: 12px;
    border: 2px solid var(--light);
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s;
    background: white;
  }

  .form-field input:focus,
  .form-field select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .input-wrapper {
    position: relative;
  }

  .input-wrapper i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 18px;
    height: 18px;
    color: var(--gray);
  }

  .input-wrapper input {
    padding-left: 40px;
    width: 100%;
  }

  /* Кнопки */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: var(--shadow-sm);
  }

  .btn i {
    width: 18px;
    height: 18px;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }

  .btn-success {
    background: var(--success);
    color: white;
  }

  .btn-success:hover {
    background: #059669;
    transform: translateY(-2px);
  }

  .btn-warning {
    background: var(--warning);
    color: white;
  }

  .btn-warning:hover {
    background: #d97706;
    transform: translateY(-2px);
  }

  .btn-ghost {
    background: transparent;
    color: var(--gray);
    box-shadow: none;
  }

  .btn-ghost:hover {
    background: var(--light);
    color: var(--dark);
  }

  .btn-block {
    width: 100%;
  }

  /* Блок профиля */
  .profile-container {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 30px;
  }

  .profile-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: var(--radius);
    padding: 30px;
    box-shadow: var(--shadow);
  }

  .card-header {
    margin-bottom: 25px;
  }

  .card-header h3 {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 20px;
    font-weight: 700;
  }

  .card-header h3 i {
    width: 24px;
    height: 24px;
    color: var(--primary);
  }

  /* Сообщения */
  .message {
    padding: 12px;
    border-radius: 8px;
    font-size: 14px;
    text-align: center;
    display: none;
  }

  .message.show {
    display: block;
  }

  .message.success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #86efac;
  }

  .message.error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
  }

  /* Адаптивность */
  @media (max-width: 768px) {
    .header-container {
      flex-direction: column;
      text-align: center;
    }

    .user-section {
      flex-direction: column;
    }

    .btn-ghost {
      width: 100%;
    }

    .profile-container {
      grid-template-columns: 1fr;
    }

    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<!-- Конфигурация -->
<script>
  window.ENV = {
    SUPABASE_URL: 'https://eqpdepmgriuivevvrulc.supabase.co',
    SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxcGRlcG1ncml1aXZldnZydWxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzNjIwOTUsImV4cCI6MjA3MTkzODA5NX0.RrU_XWmoYCitZoeq27aH9iKJrb_wczOei8P4h0e2GR8'
  };
</script>

<!-- Загрузка API -->
<script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="./js/api.js"></script>

<!-- Главная логика -->
<script type="module">
  import { supabase, loadOrCreateProfile, uploadAvatar, fetchOrgDepartments } from './js/api.js';

  // Проверка инициализации
  if (!supabase) {
    console.error('Критическая ошибка: Supabase не инициализирован');
    document.querySelector('#authMsg').textContent = 'Ошибка инициализации системы';
    document.querySelector('#authMsg').className = 'message show error';
  }

  // Глобальное состояние
  let currentUser = null;
  let currentProfile = null;

  // DOM элементы
  const elements = {
    // Контейнеры
    authContainer: document.getElementById('authContainer'),
    profileHeader: document.getElementById('profileHeader'),
    profileContainer: document.getElementById('profileContainer'),
    
    // Формы
    signinForm: document.getElementById('signinForm'),
    signupForm: document.getElementById('signupForm'),
    profileForm: document.getElementById('profileForm'),
    passwordForm: document.getElementById('passwordForm'),
    
    // Поля профиля
    firstName: document.getElementById('firstName'),
    lastName: document.getElementById('lastName'),
    jobTitle: document.getElementById('jobTitle'),
    department: document.getElementById('department'),
    phone: document.getElementById('phone'),
    officeLocation: document.getElementById('officeLocation'),
    
    // Заголовок
    headerName: document.getElementById('headerName'),
    headerEmail: document.getElementById('headerEmail'),
    headerAvatar: document.getElementById('headerAvatar'),
    headerAvatarPlaceholder: document.getElementById('headerAvatarPlaceholder'),
    avatarInput: document.getElementById('avatarInput'),
    
    // Кнопки
    btnSignOut: document.getElementById('btnSignOut'),
    
    // Сообщения
    authMsg: document.getElementById('authMsg'),
    profileMsg: document.getElementById('profileMsg'),
    passwordMsg: document.getElementById('passwordMsg')
  };

  // Утилиты для сообщений
  function setMsg(element, text, type = '') {
    if (!element) return;
    element.textContent = text;
    element.className = text ? `message show ${type}` : 'message';
    if (text && type === 'success') {
      setTimeout(() => setMsg(element, ''), 3000);
    }
  }

  // Главный контроллер состояния
  async function updateUI(session) {
    console.log('Обновление UI, сессия:', !!session);
    
    if (session?.user) {
      // Авторизован
      currentUser = session.user;
      elements.authContainer.style.display = 'none';
      elements.profileHeader.style.display = 'block';
      elements.profileContainer.style.display = 'grid';
      
      await populateProfile(session.user);
      await populateDepartments();
    } else {
      // Не авторизован
      currentUser = null;
      currentProfile = null;
      elements.authContainer.style.display = 'block';
      elements.profileHeader.style.display = 'none';
      elements.profileContainer.style.display = 'none';
    }
    
    // Обновить иконки
    if (window.lucide) lucide.createIcons();
  }

  // Загрузка и заполнение профиля
  async function populateProfile(user) {
    try {
      console.log('Загрузка профиля для:', user.email);
      
      // Загружаем или создаем профиль
      currentProfile = await loadOrCreateProfile(user);
      console.log('Профиль загружен:', currentProfile);
      
      // Заполняем поля формы
      elements.firstName.value = currentProfile.first_name || '';
      elements.lastName.value = currentProfile.last_name || '';
      elements.jobTitle.value = currentProfile.job_title || '';
      elements.department.value = currentProfile.department_name || '';
      elements.phone.value = currentProfile.phone || '';
      elements.officeLocation.value = currentProfile.office_location || '';
      
      // Обновляем заголовок
      const fullName = [currentProfile.first_name, currentProfile.last_name]
        .filter(Boolean).join(' ') || 'Пользователь';
      elements.headerName.textContent = fullName;
      elements.headerEmail.textContent = currentProfile.email || user.email;
      
      // Обновляем аватар
      if (currentProfile.avatar_url) {
        elements.headerAvatar.src = currentProfile.avatar_url;
        elements.headerAvatar.style.display = 'block';
        elements.headerAvatarPlaceholder.style.display = 'none';
      } else {
        elements.headerAvatar.style.display = 'none';
        elements.headerAvatarPlaceholder.style.display = 'flex';
      }
      
    } catch (error) {
      console.error('Ошибка загрузки профиля:', error);
      setMsg(elements.profileMsg, `Ошибка загрузки профиля: ${error.message}`, 'error');
    }
  }

  // Загрузка подразделений
  async function populateDepartments() {
    try {
      const departments = await fetchOrgDepartments();
      
      elements.department.innerHTML = '<option value="">Выберите подразделение</option>';
      departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        elements.department.appendChild(option);
      });
      
      // Восстанавливаем выбранное значение
      if (currentProfile?.department_name) {
        elements.department.value = currentProfile.department_name;
      }
      
    } catch (error) {
      console.error('Ошибка загрузки подразделений:', error);
      elements.department.innerHTML = '<option value="">Ошибка загрузки</option>';
    }
  }

  // Переключение табов
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const tab = e.target.dataset.tab;
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      
      if (tab === 'signin') {
        elements.signinForm.style.display = 'flex';
        elements.signupForm.style.display = 'none';
      } else {
        elements.signinForm.style.display = 'none';
        elements.signupForm.style.display = 'flex';
      }
    });
  });

  // Обработчик входа
  elements.signinForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    setMsg(elements.authMsg, '');
    
    try {
      const email = document.getElementById('signinEmail').value.trim();
      const password = document.getElementById('signinPassword').value.trim();
      
      if (!email || !password) {
        throw new Error('Заполните все поля');
      }
      
      setMsg(elements.authMsg, 'Выполняется вход...', 'success');
      
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      });
      
      if (error) throw error;
      
      console.log('Вход выполнен:', data.user.email);
      setMsg(elements.authMsg, 'Вход выполнен успешно!', 'success');
      elements.signinForm.reset();
      
    } catch (error) {
      console.error('Ошибка входа:', error);
      setMsg(elements.authMsg, error.message, 'error');
    }
  });

  // Обработчик регистрации
  elements.signupForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    setMsg(elements.authMsg, '');
    
    try {
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value.trim();
      
      if (!email || !password) {
        throw new Error('Заполните все поля');
      }
      
      if (password.length < 6) {
        throw new Error('Пароль должен быть не менее 6 символов');
      }
      
      setMsg(elements.authMsg, 'Создание аккаунта...', 'success');
      
      const { data, error } = await supabase.auth.signUp({
        email,
        password
      });
      
      if (error) throw error;
      
      console.log('Регистрация выполнена:', data);
      setMsg(elements.authMsg, 'Регистрация успешна! Проверьте email для подтверждения.', 'success');
      elements.signupForm.reset();
      
    } catch (error) {
      console.error('Ошибка регистрации:', error);
      setMsg(elements.authMsg, error.message, 'error');
    }
  });

  // Обработчик выхода
  elements.btnSignOut.addEventListener('click', async () => {
    try {
      const { error } = await supabase.auth.signOut();
      if (error) throw error;
      
      console.log('Выход выполнен');
      setMsg(elements.authMsg, 'Вы вышли из системы', 'success');
      
    } catch (error) {
      console.error('Ошибка выхода:', error);
    }
  });

  // Сохранение профиля
  elements.profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    setMsg(elements.profileMsg, '');
    
    try {
      setMsg(elements.profileMsg, 'Сохранение...', 'success');
      
      const updates = {
        first_name: elements.firstName.value.trim(),
        last_name: elements.lastName.value.trim(),
        job_title: elements.jobTitle.value.trim(),
        department_name: elements.department.value || null,
        phone: elements.phone.value.trim(),
        office_location: elements.officeLocation.value.trim(),
        updated_at: new Date().toISOString()
      };
      
      const { data, error } = await supabase
        .from('profiles')
        .update(updates)
        .eq('user_id', currentUser.id)
        .select()
        .single();
      
      if (error) throw error;
      
      currentProfile = data;
      
      // Обновляем заголовок
      const fullName = [data.first_name, data.last_name]
        .filter(Boolean).join(' ') || 'Пользователь';
      elements.headerName.textContent = fullName;
      
      setMsg(elements.profileMsg, 'Профиль сохранен!', 'success');
      
    } catch (error) {
      console.error('Ошибка сохранения:', error);
      setMsg(elements.profileMsg, error.message, 'error');
    }
  });

  // Смена пароля
  elements.passwordForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    setMsg(elements.passwordMsg, '');
    
    try {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (!newPassword || newPassword.length < 6) {
        throw new Error('Пароль должен быть не менее 6 символов');
      }
      
      if (newPassword !== confirmPassword) {
        throw new Error('Пароли не совпадают');
      }
      
      setMsg(elements.passwordMsg, 'Изменение пароля...', 'success');
      
      const { error } = await supabase.auth.updateUser({
        password: newPassword
      });
      
      if (error) throw error;
      
      elements.passwordForm.reset();
      setMsg(elements.passwordMsg, 'Пароль успешно изменен!', 'success');
      
    } catch (error) {
      console.error('Ошибка смены пароля:', error);
      setMsg(elements.passwordMsg, error.message, 'error');
    }
  });

  // Загрузка аватара
  elements.avatarInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      setMsg(elements.profileMsg, 'Загрузка аватара...', 'success');
      
      // Загружаем файл
      const avatarUrl = await uploadAvatar(file, currentUser.id);
      
      // Обновляем профиль
      const { data, error } = await supabase
        .from('profiles')
        .update({
          avatar_url: avatarUrl,
          updated_at: new Date().toISOString()
        })
        .eq('user_id', currentUser.id)
        .select()
        .single();
      
      if (error) throw error;
      
      currentProfile = data;
      
      // Обновляем UI
      elements.headerAvatar.src = avatarUrl;
      elements.headerAvatar.style.display = 'block';
      elements.headerAvatarPlaceholder.style.display = 'none';
      
      setMsg(elements.profileMsg, 'Аватар обновлен!', 'success');
      
    } catch (error) {
      console.error('Ошибка загрузки аватара:', error);
      setMsg(elements.profileMsg, error.message, 'error');
    }
    
    // Очищаем input
    e.target.value = '';
  });

  // Инициализация
  async function init() {
    console.log('Инициализация профиля...');
    
    // Проверяем текущую сессию
    const { data: { session } } = await supabase.auth.getSession();
    await updateUI(session);
    
    // Подписываемся на изменения авторизации
    supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('Auth state changed:', event);
      await updateUI(session);
    });
  }

  // Запускаем приложение
  init().catch(console.error);
</script>

</body>
</html>